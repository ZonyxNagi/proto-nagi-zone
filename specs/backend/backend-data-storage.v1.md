# nagizone. Backend Data Entities and Storage

## Abstract
This document describes the data entities and storage solutions used in the backend system of the _nagizone_ web platform.

## Background
_nagizone_ is a web solution designed for swimmers, offering storage and statistics for their swimming sessions.

_nagizone_ obtains its source data from swimming pools equipped with _nagi_. _nagi_ is an indoor tracking solution for swimmers that provides security features and allows swimmers to monitor their swim activities, including sessions and related statistics.

Swimmers using _nagi_ wear a Bluetooth tag while swimming, enabling _nagi_ to determine their precise location in the pool and track their swimming activity (speed, duration, distance).

## Nagizone Data Entities
### Users
A _user_ of _nagi_ and _nagizone_ is a swimmer who organizes their swim activities into _sessions_. Each _session_ is composed of one or more _laps_, where a _lap_ represents one complete length of the pool.

The _user_'s location is tracked by _nagi_ using a _tag_. A _user_ can have one or more _tags_, and each _tag_ is assigned to a unique _user_.

### Sessions
A _session_ is a collection of data representing a swim session performed by a _user_ in a swimming pool equipped with _nagi_.

A session takes place on a specific date in a particular swimming pool and is associated with a _user_ wearing a _tag_. Since each _tag_ is assigned to a single _user_, a session can be linked to a user by identifying the _tag_ used during that session.

A session consists of one or more _laps_.

### Session Laps
A (session) _lap_ is one complete length of a _nagi_-equipped swimming pool swum by a _user_ wearing a _tag_.

A _lap_ has a defined distance (the length of the swimming pool) and duration. From these, the _pace_ (speed) of the lap can be calculated.

### Time Periods
A _time period_ is an abstract concept (and therefore not stored directly) that allows for the grouping of sessions over time, enabling the aggregation of session data.

The recognized _time periods_ are _week_, _month_, and _year_. Sessions are grouped based on when they occurred within a specific _week_, _month_, or _year_.

By grouping sessions into _time periods_, statistical data can be generated, such as:
- The number of sessions in a _time period_.
- The total and average distance and time swum in the sessions within a _time period_.
- The maximum, minimum, and average swimming _pace_ in the sessions within a _time period_.
- The total and average number of laps per session within a _time period_.

### Swimming statistics

A _statistic_ is a set of aggregated numerical values derived from one or more swimming sessions performed by a user over a specific time period. These aggregated values provide insights into the user's swimming activity and performance.

A _statistic_ is always associated with a specific user and calculated for a defined time period (which can be a week, month, or year, or an overall accumulation).

A _statistic_ may include measures such as the total number of sessions, the total and average distance and time swum, and the best (maximum, minimum, average) swimming pace achieved. It also includes the total and average number of laps per session.

Different types of statistic entities may exist based on the time period they cover:

- Overall Statistics: Represent the accumulated statistics across all recorded sessions for a user.
- Yearly Statistics: Represent the statistics for all sessions of a user within a specific year.
- Monthly Statistics: Represent the statistics for all sessions of a user within a specific month of a given year.
- Weekly Statistics: Represent the statistics for all sessions of a user within a specific week of a given year.
- Session statistics: Represent the statistics for a given sessions of a user.

## Nagizone Backend Storage

The _nagizone_ backend stores data entities in two different storage solutions:
- A MongoDB database, considered as the system's main permanent data storage repository.
- A Redis database, storing part of the information stored in the MongoDB database and used for improving the backend system performance by acting as a cache system.

### MongoDB Storage

#### users
- **Collection Name:** `users`
- **Description:** Stores _user_ entities.
- **Fields:**

| Field             | Type        | Description                                                                                             |
| ----------------- | ----------- | ------------------------------------------------------------------------------------------------------- |
| `_id`             | ObjectId    | Unique user identifier (generated by MongoDB)                                                           |
| `id`              | string      | Unique user identifier (generated by an external user management system, such as Firebase)               |
| `name`            | string      | User name                                                                                               |
| `email`           | string      | User email                                                                                              |
| `photo`           | string      | URL to the user's photo file                                                                            |
| `privatePolicies` | array       | Array of `privacyPolicy` documents representing accepted privacy policies.                               |
| `privatePolicies.version` | string      | Privacy policy version                                                                                |
| `privatePolicies.date`    | string      | Date when the privacy policy was accepted by the user                                              |
| `privatePolicies.businessCommunications` | boolean     | True if the user agreed to receive business communications.                               |
| `privatePolicies.marketingSegmentation` | boolean     | True if the user accepted the marketing segmentation policy terms.                         |
| `privatePolicies.dataTransfer`        | boolean     | True if the user agreed that their data could be transferred to third parties.              |
| `latestSession`        | ObjectId     | ObjectId of the latest _user_ _session__.              |

#### sessions
- **Collection Name:** `sessions`
- **Description:** Stores _session_ entities.
- **Fields:**

| Field       | Type     | Description                                                                                                |
| ----------- | -------- | ---------------------------------------------------------------------------------------------------------- |
| `_id`       | ObjectId | Unique session identifier (generated by MongoDB)                                                             |
| `id`        | string   | Unique session identifier (generated by _nagi_)                                                              |
| `facilityId`| string   | Unique facility id.                                                                                        |
| `poolId`    | string   | Facility pool id, unique at facility level.                                                                |
| `userId`    | string   | Id of the user performing the swimming session. References `users.id`.                                      |
| `startDate` | date     | Session start date                                                                                         |
| `duration`  | int      | Session duration, in milliseconds                                                                          |
| `restTime`  | int      | Time in the session the user was not swimming, in milliseconds                                             |
| `distance`  | int      | Distance swum during the session, in metres                                                                 |
| `laps`      | array    | Sorted list of `lap` entities.                                                                             |
| `laps.startDate`| date     | Lap start date                                                                                             |
| `laps.duration` | int      | Lap duration, in milliseconds                                                                              |
| `laps.distance` | int      | Lap distance, in metres                                                                                  |

#### stats
- **Collection Name:** `stats`
- **Description:** Stores the overall _sessions_ stats of a user.
- **Relationship:** One-to-one with Users (identified by `userId`).
- **Fields:**

| Field                 | Type     | Description                                                                                                                                                                                             |
| --------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `userId`              | ObjectId | `_id` field value in the `users` collection object storing the user the stats refers to.                                                                                                              |
| `accumulated`         | object   | Object storing the total stats of a user.                                                                                                                                                             |
| `accumulated.distance`| int      | Overall distance swum by the user, in metres.                                                                                                                                                         |
| `accumulated.laps`    | int      | Overall laps swum by the user.                                                                                                                                                                         |
| `accumulated.time`    | int      | Overall time spent swimming by the user, in milliseconds.                                                                                                                                             |
| `accumulated.sessions`| int      | Number of swimming sessions.                                                                                                                                                                          |
| `best`                | object   | Object storing the best session records of a user.                                                                                                                                                    |
| `best.distance`       | object   | Object containing data related to the maximum distance swum in a session.                                                                                                                             |
| `best.distance.value`   | int      | Maximum distance swum in a session, in metres.                                                                                                                                                        |
| `best.distance.sessionId` | ObjectId | `_id` field value in the `sessions` collection object storing the session with the maximum swum distance.                                                                                              |
| `best.laps`           | object   | Object containing data related to the maximum number of laps completed in a session.                                                                                                                  |
| `best.laps.value`       | int      | Maximum number of completed laps.                                                                                                                                                                     |
| `best.laps.sessionId` | ObjectId | `_id` field value in the `sessions` collection object storing the session with the maximum number of completed laps.                                                                                      |
| `best.pace`           | object   |  Object containing the data related to the minimum pace achieved in a session, calculated as: `(total session duration - total rest time) / total session distance * 100`. This represents the average time in milliseconds to swim 100 meters across the entire active swimming time of the session (lower is better)                                                   |
| `best.pace.value`       | int      | Minimum time, in milliseconds, for swimming 100 metres.                                                                                                                                               |
| `best.pace.sessionId` | ObjectId | `_id` field value in the `sessions` collection object when the best pace was achieved.                                                                                                                  |
| `best.time`           | object   | Object containing data related to the maximum amount of time spent swimming in a single session.                                                                                                     |
| `best.time.value`       | int      | Maximum time swimming in a single session, in milliseconds.                                                                                                                                          |
| `best.time.sessionId` | ObjectId | `_id` field value in the `sessions` collection object storing the session with the maximum swum time.                                                                                                   |
| `best.session`        | ObjectId | `_id` field value in the `sessions` collection object that stores the best considered user swimming session (the criteria for "best" might need further definition).                                     |

#### yearlyStats
- **Collection Name:** `yearlyStats`
- **Description:** Stores the overall _sessions_ stats of a user recorded in a given year.
- **Relationship:** Many-to-one with Users (identified by `userId`).
- **Fields:** Same structure as the `stats` collection, with the addition of:

| Field | Type | Description                      |
| ----- | ---- | -------------------------------- |
| `year`| int  | The year the stats refer to.     |

#### monthlyStats
- **Collection Name:** `monthlyStats`
- **Description:** Stores the overall _sessions_ stats of a user recorded in a given month.
- **Relationship:** Many-to-one with Users (identified by `userId`).
- **Fields:** Same structure as the `yearlyStats` collection, with the addition of:

| Field | Type | Description                           |
| ----- | ---- | ------------------------------------- |
| `month`| int  | The month of the year (1-12) the stats refer to. |

#### weeklyStats
- **Collection Name:** `weeklyStats`
- **Description:** Stores the overall _sessions_ stats of a user recorded in a given week of the year.
- **Relationship:** Many-to-one with Users (identified by `userId`).
- **Fields:** Same structure as the `yearlyStats` collection, with the addition of:

| Field | Type | Description                           |
| ----- | ---- | ------------------------------------- |
| `week` | int  | The week of the year (1-53) the stats refer to. |

## Redis storage

### Management of Redis as cache
The data requests served by the backend system will first search for the required data in Redis. If the data is not found, it will be retrieved from MongoDB, then stored in Redis, and then served.

Data updates performed by the backend system will create/update data documents in Mongo and, if present, will be deleted from Redis to ensure cache coherence.

### Redis documents
In order to improve the performance of the Redis cache, the information stored (mainly those documents described in the section [MongoDB storage](#mongodb-storage)) will be serialized as CBOR, hence reducing the information size and data transfer compared with serializing it as JSON.

#### Users
- **Key:** `user:<user_id>`, where `<user_id>` is the `_id` field of a `users` MongoDB document.
- **Value:** CBOR representation of a `users` MongoDB collection document whose `_id` field is used in the key.

#### Sessions
- **Key:** `sessions:<user_id>`, where `<user_id>` is the `_id` field of a `users` MongoDB document.
- **Value:** Redis hash. Each hash item has two key-value options:
    - If the hash item has a key with the format `<year>:<month>` (e.g., `2025:01` for January 2025), its value is a CBOR representation of an array of the user's sessions in that month.
    - If the hash item has a key with the value `latest`, its value is a CBOR representation of the latest _user_ session.
    
All the sessions in a given entry belong to the user identified by `<user_id>` in the Redis hash key.

#### Stats
- **Key:** `stats:<user_id>`, where `<user_id>` is the `_id` field of a `users` MongoDB document.
- **Value:** CBOR representation of a `stats` MongoDB document related to the user identified by `<user_id>` in the key.

#### Yearly stats
- **Key:** `yearlyStats:<user_id>`, where `<user_id>` is the `_id` field of a `users` MongoDB document.
- **Value:** Redis hash. Each hash item has:
    - **Key:** `<year>` (e.g., `2025`).
    - **Value:** CBOR representation of a `yearlyStats` MongoDB document for that year. All stats belong to the user identified by `<user_id>` in the key.

#### Monthly stats
- **Key:** `monthlyStats:<user_id>`, where `<user_id>` is the `_id` field of a `users` MongoDB document.
- **Value:** Redis hash. Each hash item has:
    - **Key:** `<year>:<month>` (e.g., `2025:01`).
    - **Value:** CBOR representation of a `monthlyStats` MongoDB document for that month. All stats belong to the user identified by `<user_id>` in the key.

#### Weekly stats
- **Key:** `weeklyStats:<user_id>`, where `<user_id>` is the `_id` field of a `users` MongoDB document.
- **Value:** Redis hash. Each hash item has:
    - **Key:** `<year>:<week>` (e.g., `2025:01`).
    - **Value:** CBOR representation of a `weeklyStats` MongoDB document for that week. All stats belong to the user identified by `<user_id>` in the key.